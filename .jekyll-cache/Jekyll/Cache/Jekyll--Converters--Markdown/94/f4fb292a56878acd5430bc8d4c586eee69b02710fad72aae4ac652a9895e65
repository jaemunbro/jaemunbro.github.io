I"/Õ<p>ìŠ¤íŒŒí¬ì˜ ë¬¸ì œ ì‚¬ë¡€ë“¤ê³¼ ê·¸ í•´ê²° ë°©ë²•ë“¤ì— ëŒ€í•´ ì•Œì•„ë³´ì.<br />
ë¬¸ì œ ì¼€ì´ìŠ¤ë“¤ì€ ì¼ë¶€ ì§ì ‘ ê²ªì€ ê²ƒë“¤ê³¼ ë³¸ë¬¸ í•˜ë‹¨ ë§í¬ì˜ ì¼€ì´ìŠ¤ë“¤ì„ ì·¨í•©í•˜ì˜€ë‹¤.</p>

<h1 id="troubleshooting-tips">Troubleshooting Tips</h1>
<hr />

<h2 id="íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì„-ìœ„í•´-verbose-modeë¥¼-í™œìš©í•˜ì">íŠ¸ëŸ¬ë¸”ìŠˆíŒ…ì„ ìœ„í•´ verbose modeë¥¼ í™œìš©í•˜ì</h2>
<p><code class="language-plaintext highlighter-rouge">spark-submit --driver-memory 10g --verbose --master yarn --executor memory...</code><br />
ë‹¤ìŒ ì •ë³´ë“¤ì´ í”„ë¦°íŠ¸ëœë‹¤.</p>
<ul>
  <li>all default properties</li>
  <li>command line options</li>
  <li>setting from spark â€˜confâ€™ file</li>
  <li>setting from CLI</li>
</ul>

<h2 id="executor-thread--heap-dump">executor thread &amp; heap dump</h2>
<p><code class="language-plaintext highlighter-rouge">jmap, jstack, jstat, jhat</code>ê³¼ ê°™ì€ OpenJDK íˆ´ì„ í†µí•´ executorì˜ thread dumpë‚˜ heap dumpë¥¼ ë– ë³¼ ìˆ˜ ìˆë‹¤.
YARN ì»¨í…Œì´ë„ˆì˜ pidë¥¼ ì°¾ì•„ì„œ ì‚¬ìš©í•œë‹¤.</p>
<ul>
  <li>for full thread dump
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre>jstack <span class="nt">-l</span> 355583 <span class="o">&gt;</span> javacore.355583
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>for full heap dump
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre>jmap <span class="nt">-dump</span>:live,format<span class="o">=</span>b,file<span class="o">=</span>heapdump.355583 355583 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h1 id="error-cases">Error Cases</h1>
<hr />

<h3 id="compiled-ok-but-run-time-noclassdeffounderror">Compiled OK, but run-time NoClassDefFoundError</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="nl">NoClassDefFoundError:</span> <span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">"main"</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NoClassDefFoundError</span><span class="o">:</span> <span class="n">org</span><span class="o">/</span><span class="n">apache</span><span class="o">/</span><span class="n">kafka</span><span class="o">/</span><span class="n">clients</span><span class="o">/</span><span class="n">producer</span><span class="o">/</span><span class="nc">KafkaProducer</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">getDeclaredMethods0</span><span class="o">(</span><span class="nc">Native</span> <span class="nc">Method</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">privateGetDeclaredMethods</span><span class="o">(</span><span class="nc">Class</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2701</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">privateGetMethodRecursive</span><span class="o">(</span><span class="nc">Class</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">3048</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">getMethod0</span><span class="o">(</span><span class="nc">Class</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">3018</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">--packages</code> ë¥¼ í†µí•´ Maven Jar í¬í•¨
e.g.)</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="n">spark</span><span class="o">-</span><span class="n">submit</span> <span class="o">--</span><span class="n">driver</span><span class="o">-</span><span class="n">memory</span> <span class="mi">12</span><span class="n">g</span> <span class="o">--</span><span class="n">verbose</span> <span class="o">--</span><span class="n">master</span> <span class="n">yarn</span><span class="o">-</span><span class="n">client</span> <span class="o">--</span><span class="n">executor</span><span class="o">-</span><span class="n">memory</span> <span class="mi">4096</span><span class="n">m</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">executors</span> <span class="mi">20</span>  <span class="o">--</span><span class="n">packages</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">:</span><span class="n">spark</span><span class="o">-</span><span class="n">streaming</span><span class="o">-</span><span class="n">kafka_2</span><span class="o">.</span><span class="mi">10</span><span class="o">:</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>repo look up ìˆœì„œ
    <ol>
      <li>local Maven repo - local machine</li>
      <li>Maven centoral - Web</li>
      <li>Additional remote repositories specified in - repositories</li>
    </ol>
  </li>
</ul>

<h3 id="no-space-left-on-device">No space left on device</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="n">stage</span> <span class="mf">89.3</span> <span class="n">failed</span> <span class="mi">4</span> <span class="n">times</span><span class="o">,</span> <span class="n">most</span> <span class="n">recent</span> <span class="nl">failure:</span> <span class="nc">Lost</span> <span class="n">task</span> <span class="mf">38.4</span> <span class="n">in</span> <span class="n">stage</span> <span class="mf">89.3</span> <span class="o">(</span><span class="no">TID</span> <span class="mi">30100</span><span class="o">,</span> <span class="n">rhel4</span><span class="o">.</span><span class="na">cisco</span><span class="o">.</span><span class="na">com</span><span class="o">):</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">:</span> <span class="nc">No</span> <span class="n">space</span> <span class="n">left</span> <span class="n">on</span> <span class="n">device</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">FileOutputStream</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="nc">Native</span> <span class="nc">Method</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">FileOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">FileOutputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">326</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">TimeTrackingOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">TimeTrackingOutputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">58</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">BufferedOutputStream</span><span class="o">.</span><span class="na">flushBuffer</span><span class="o">(</span><span class="nc">BufferedOutputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">82</span><span class="o">)</span> <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">BufferedOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">BufferedOutputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">126</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ì–¼ë§ˆì „ ìš´ì˜ì¤‘ì¸ í´ëŸ¬ìŠ¤í„°ì—ì„œ ë°œìƒí–ˆë˜ ì—ëŸ¬ë‹¤.<br />
ìŠ¤íŒŒí¬ê°€ map output fileë“¤ê³¼ RDDë¥¼ ì €ì¥í•´ë‘ëŠ” <code class="language-plaintext highlighter-rouge">/tmp</code>ê°€ ê½‰ì°¬ ê²½ìš°ë‹¤. ì¼ë‹¨ì€ cronì— ì •ê¸°ì ìœ¼ë¡œ tmp ì •ë¦¬ë¥¼ í†µí•´ í•´ê²°í–ˆë‹¤.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">spark.local.dir</code> íŒŒë¼ë¯¸í„°ê°’ì˜ ë””í´íŠ¸ê°’ì´ <code class="language-plaintext highlighter-rouge">/tmp</code>ì¸ë°, ê·¼ë³¸ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">/tmp</code>ë¥¼ Sparkì˜ scratch ê³µê°„ìœ¼ë¡œ ë‘ëŠ” ê²ƒ ìì²´ê°€ ì ì ˆì¹˜ ì•Šë‹¤. ì•„ë˜ ë‘ê°€ì§€ ì´ìœ  ë•Œë¬¸ì¸ë°
    <ol>
      <li><code class="language-plaintext highlighter-rouge">/tmp</code>ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì‘ì€ ê³µê°„ì´ í• ë‹¹ë˜ë©° OSë¥¼ ìœ„í•œ ê³µê°„ì´ë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">/tmp</code>ëŠ” ë³´í†µ single diskë¡œ IO bottleneckì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆë‹¤.</li>
    </ol>
  </li>
  <li><code class="language-plaintext highlighter-rouge">spark-defualts.conf</code>ì— ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì„ ì¶”ê°€í•˜ì.<br />
<code class="language-plaintext highlighter-rouge">spark.local.dir /data/disk1/tmp,/data/disk2/tmp,/data/disk3/tmp,/data/disk4/tmp,...</code></li>
</ul>

<h3 id="brodcasttimeout-error">BrodcastTimeout Error</h3>
<p>ì—­ì‹œ ìµœê·¼ í´ëŸ¬ìŠ¤í„°ì—ì„œ ë°œìƒí–ˆëŠ”ë°, ëª…í™•í•˜ê²Œ BroadcastTimeout Errorë¼ê³  ë–¨ì–´ì§€ëŠ” ê²½ìš°ë„ ìˆì§€ë§Œ, surfaceìƒì—ëŠ” Catalyst errorë¡œ ë–¨ì–´ì§€ëŠ” ê²½ìš°ë„ ìˆëŠ” ê²ƒ ê°™ë‹¤.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre> <span class="nc">Typical</span> <span class="n">error</span> <span class="n">stream7</span><span class="o">/</span><span class="n">query_07_24_48</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">out</span><span class="o">:</span><span class="nl">Error:</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">errors</span><span class="o">.</span><span class="na">package</span><span class="n">$TreeNodeException</span><span class="o">:</span> <span class="n">execute</span><span class="o">,</span> <span class="nl">tree:</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">exchange</span><span class="o">.</span><span class="na">ShuffleExchange</span><span class="err">$</span><span class="n">$anonfun$doExecute</span> <span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">ShuffleExchange</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">122</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">exchange</span><span class="o">.</span><span class="na">ShuffleExchange</span><span class="err">$</span><span class="n">$anonfun$doExecute</span> <span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">ShuffleExchange</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">113</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">errors</span><span class="o">.</span><span class="na">package</span><span class="err">$</span><span class="o">.</span><span class="na">attachTree</span><span class="o">(</span><span class="kn">package</span><span class="nn">.scala</span><span class="o">:</span><span class="mi">49</span><span class="o">)</span> <span class="o">...</span> <span class="mi">96</span> <span class="n">more</span> <span class="nc">Caused</span> <span class="nl">by:</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">TimeoutException</span><span class="o">:</span> <span class="nc">Futures</span> <span class="n">timed</span> <span class="n">out</span> <span class="n">after</span> <span class="o">[</span><span class="mi">800</span> <span class="n">seconds</span><span class="o">]</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">Promise</span><span class="n">$DefaultPromise</span><span class="o">.</span><span class="na">ready</span><span class="o">(</span><span class="nc">Promise</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">219</span><span class="o">)</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">Promise</span><span class="n">$DefaultPromise</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="nc">Promise</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">223</span><span class="o">)</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">Await</span><span class="err">$</span><span class="n">$anonfun$result</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kn">package</span><span class="nn">.scala</span><span class="o">:</span><span class="mi">190</span><span class="o">)</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">BlockContext</span><span class="n">$DefaultBlockContext</span><span class="err">$</span><span class="o">.</span><span class="na">blockOn</span><span class="o">(</span><span class="nc">BlockContext</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">53</span><span class="o">)</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">Await</span><span class="err">$</span><span class="o">.</span><span class="na">result</span><span class="o">(</span><span class="kn">package</span><span class="nn">.scala</span><span class="o">:</span><span class="mi">190</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ThreadUtils</span><span class="err">$</span><span class="o">.</span><span class="na">awaitResult</span><span class="o">(</span><span class="nc">ThreadUtils</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">190</span><span class="o">)</span> <span class="o">...</span> <span class="mi">208</span> <span class="n">more</span> <span class="err">Â§â€¯</span> <span class="nc">On</span> <span class="n">surface</span> <span class="n">appears</span> <span class="n">to</span> <span class="n">be</span> <span class="nc">Catalyst</span> <span class="nf">error</span> <span class="o">(</span><span class="n">optimizer</span><span class="o">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">spark.sql.broadcastTimeout 1200</code> ì²˜ëŸ¼ parameterë¥¼ ëŠ˜ë ¤ì£¼ëŠ” ì„¤ì •ì„ í†µí•´ í•´ê²°í•œë‹¤. 
broadcastí•˜ëŠ” sizeì˜ limitì´ ìˆìœ¼ë¯€ë¡œ, ë¬´ì œí•œìœ¼ë¡œ broadcast ë˜ì§€ëŠ” ì•Šì„ ê²ƒì´ë¼ ë³´ì•˜ë‹¤. í´ëŸ¬ìŠ¤í„°ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ê¸´ ì¿¼ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ì„¸íŒ…í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.</p>

<h3 id="out-of-memory-exceptions">Out of Memory Exceptions</h3>
<p>Spark Jobì´ Executor ë˜ëŠ” Driverì˜ out of memory exceptionìœ¼ë¡œ ì¸í•´ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆë‹¤.
ì¼ë°˜ì ìœ¼ë¡œëŠ” Executorì˜ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ìƒí™©ì„ ë§ì´ ë§Œë‚˜ê²Œ ëœë‹¤. 
Executorì˜ ì‚¬ì´ì¦ˆë¥¼ ëŠ˜ë ¤ì£¼ëŠ” ë°©ë²•ì„ í†µí•´ í•´ê²°í•  ìˆ˜ë„ ìˆì§€ë§Œ, ê·¼ë³¸ì ìœ¼ë¡œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì–¼ë§ˆë‚˜ ë§ì€ ë©”ëª¨ë¦¬ë¥¼ í•„ìš”ë¡œ í•˜ëŠ”ì§€ ì´í•´í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ì´ ë¶€ë¶„ì€ ìŠ¤íŒŒí¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìµœì í™”ì— ìˆì–´ì„œ ê°€ì¥ ê¸°ë³¸ì ì´ê³  í•„ìˆ˜ì ì¸ íŒŒë¼ë¯¸í„° ë¶€ë¶„ì´ë¯€ë¡œ ë°˜ë“œì‹œ ì•Œì•„ë‘ëŠ” ê²ƒì´ ì¢‹ë‹¤.<br />
ì•„ë˜ ë¶€í„° Driverì™€ Executorì˜ ë©”ëª¨ë¦¬ ì—ëŸ¬ ìƒí™©ë“¤ì— ëŒ€í•´ì„œ ë” ì•Œì•„ë³´ì.</p>

<h3 id="driver-memory-exceptions">Driver Memory Exceptions</h3>
<p>ë“œë¼ì´ë²„ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš°ëŠ” ë³´í†µ (íœ´ë¨¼ ì—ëŸ¬ê°€ ì•„ë‹ˆë¼ë©´) <code class="language-plaintext highlighter-rouge">--driver-memory</code> ì„¤ì •ì„ í†µí•´ í•´ê²°í•œë‹¤. Defaultê°’ì¸ 512MëŠ” ì¼ë°˜ì ìœ¼ë¡œ ìš´ì˜í™˜ê²½ì—ì„œëŠ” ë„ˆë¬´ ì‘ì€ ê°’ì´ë‹¤.<br />
<em>Spark SQLê³¼ Spark Strmeaingì€ ì¼ë°˜ì ìœ¼ë¡œ í° driver heap sizeë¥¼ ìš”êµ¬í•˜ëŠ” spark jobì˜ í˜•íƒœ</em>ë‹¤.</p>

<h3 id="exception-due-to-spark-driver-running-out-of-memory">Exception due to Spark driver running out of memory</h3>
<p>ë“œë¼ì´ë²„ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš° ì•„ë˜ì™€ ê°™ì€ í˜•íƒœì˜ ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">"broadcast-exchange-0"</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="nc">Not</span> <span class="n">enough</span> <span class="n">memory</span> <span class="n">to</span> <span class="n">build</span> <span class="n">and</span> <span class="n">broadcast</span> <span class="n">the</span> <span class="n">table</span>
<span class="n">to</span> <span class="n">all</span> <span class="n">worker</span> <span class="n">nodes</span><span class="o">.</span> <span class="nc">As</span> <span class="n">a</span> <span class="n">workaround</span><span class="o">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">either</span> <span class="n">disable</span> <span class="n">broadcast</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">autoBroadcastJoinThreshold</span> <span class="n">to</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">or</span> <span class="n">increase</span> <span class="n">the</span> <span class="n">spark</span> <span class="n">driver</span> <span class="n">memory</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">spark</span><span class="o">.</span><span class="na">driver</span><span class="o">.</span><span class="na">memory</span> <span class="n">to</span> <span class="n">a</span> <span class="n">higher</span> <span class="n">value</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ì—ëŸ¬ ë©”ì‹œì§€ ìƒ workaroundë¥¼ ì œì‹œëœëŒ€ë¡œ, í•´ë‹¹ jobì— ëŒ€í•´ì„œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¡°ì¸ì„ ë„ê±°ë‚˜, ì•„ë‹ˆë©´ ë“œë¼ì´ë²„ ë©”ëª¨ë¦¬ì˜ ì„¸íŒ…ì„ ëŠ˜ë ¤ì¤˜ì„œ í•´ê²°í•  ìˆ˜ ìˆë‹¤. 
ì•„ë¬´ë˜ë„ ë©”ëª¨ë¦¬ê°€ í—ˆìš©í•œë‹¤ë©´ ë‹¹ì—°íˆ í›„ìê°€ ì¢‹ì„ ê²ƒì´ë‹¤. 
<code class="language-plaintext highlighter-rouge">--conf spark.driver.memory= &lt;XX&gt;g</code></p>

<h3 id="job-failure-because-the-application-master-that-launches-the-driver-exceeds-memory-limits">Job failure because the Application Master that launches the driver exceeds memory limits</h3>
<p>Application Master(AM)ì´ ë“œë¼ì´ë²„ë¥¼ ë©”ëª¨ë¦¬ ë¦¬ë°‹ì„ ë„˜ê²¨ì„œ ëŸ°ì¹­í–ˆê³  YARNì— ì˜í•´ terminatedëœ ê²½ìš°.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="nl">Diagnostics:</span> <span class="nc">Container</span> <span class="o">[</span><span class="n">pid</span><span class="o">=&lt;</span><span class="no">XXXXX</span><span class="o">&gt;,</span><span class="n">containerID</span><span class="o">=</span><span class="n">container_</span><span class="o">&lt;</span><span class="no">XXXXXXXXXX</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="no">XXXX</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="no">XX</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="no">XXXXXX</span><span class="o">&gt;]</span> <span class="n">is</span> <span class="n">running</span> <span class="n">beyond</span> <span class="n">physical</span> <span class="n">memory</span> <span class="n">limits</span><span class="o">.</span>
<span class="nc">Current</span> <span class="nl">usage:</span> <span class="o">&lt;</span><span class="no">XX</span><span class="o">&gt;</span> <span class="no">GB</span> <span class="n">of</span> <span class="o">&lt;</span><span class="no">XX</span><span class="o">&gt;</span> <span class="no">GB</span> <span class="n">physical</span> <span class="n">memory</span> <span class="n">used</span><span class="o">;</span> <span class="o">&lt;</span><span class="no">XX</span><span class="o">&gt;</span> <span class="no">GB</span> <span class="n">of</span> <span class="o">&lt;</span><span class="no">XX</span><span class="o">&gt;</span> <span class="no">GB</span> <span class="n">virtual</span> <span class="n">memory</span> <span class="n">used</span><span class="o">.</span> <span class="nc">Killing</span> <span class="n">container</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="executor-memory-exceptions">Executor Memory Exceptions</h2>
<h3 id="exception-because-executor-runs-out-of-memory">Exception because executor runs out of memory</h3>
<p>ìŠ¤íŒŒí¬ ìš´ì˜ ì¤‘ ì¢…ì¢… ë§ˆì£¼ì¹˜ê²Œ ë˜ëŠ” ì „í˜•ì ì¸ GC issue.</p>
<ul>
  <li>garbage collectionì— 98% ì´ìƒì˜ total timeì´ ì“°ì—¬ì§€ê³  ìˆëŠ” ê²½ìš°</li>
  <li>gcë¥¼ í†µí•´ 2% ì´í•˜ì˜ heapì´ íšŒë³µëœ ê²½ìš°</li>
  <li>top commandë¥¼ í†µí•´ í™•ì¸í–ˆì„ ë•Œ, 1 cpu coreê°€ 100% ì‚¬ìš©ë¥ ì„ ì¹˜ê³  ìˆëŠ”ë° ì™„ë£Œë˜ê³  ìˆëŠ” jobì€ ì—†ëŠ” ê²½ìš°
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="nc">Executor</span> <span class="n">task</span> <span class="n">launch</span> <span class="n">worker</span> <span class="k">for</span> <span class="n">task</span> <span class="no">XXXXXX</span> <span class="no">ERROR</span> <span class="nl">Executor:</span> <span class="nc">Exception</span> <span class="n">in</span> <span class="n">task</span> <span class="no">XX</span><span class="o">.</span><span class="na">X</span> <span class="n">in</span> <span class="n">stage</span> <span class="no">X</span><span class="o">.</span><span class="na">X</span> <span class="o">(</span><span class="no">TID</span> <span class="no">XXXXXX</span><span class="o">)</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="no">GC</span> <span class="n">overhead</span> <span class="n">limit</span> <span class="n">exceeded</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <ol>
      <li>Executorì˜ ì‚¬ì´ì¦ˆë¥¼ ëŠ˜ë ¤ì£¼ëŠ” ë°©ë²•ì„ í†µí•´ í•´ê²°í•œë‹¤.<br />
<code class="language-plaintext highlighter-rouge">--conf spark.executor.memory= &lt;XX&gt;g</code></li>
    </ol>
  </li>
</ul>

<ol>
  <li>GC policyë¥¼ ë³€ê²½í•œë‹¤.
    <ul>
      <li>Spark defaultëŠ” -XX:UseParallelGC</li>
      <li>-XX:G1GC ë¡œ overwriteì„ ì‹œë„í•´ë³¼ ìˆ˜ ìˆë‹¤.</li>
      <li>Defaultê°€ ì¼ë°˜ì ìœ¼ë¡œ ì¢‹ì§€ë§Œ, ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. (ìì„¸í•œ ë‚´ìš©ì€ ë³„ë„ì˜ í¬ìŠ¤íŠ¸ì—ì„œ ë‹¤ë£¨ê³ ì í•œë‹¤)</li>
    </ul>
  </li>
</ol>

<h3 id="fetchfailedexception-due-to-executor-running-out-of-memory">FetchFailedException due to executor running out of memory</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="nc">ShuffleMapStage</span> <span class="nf">XX</span> <span class="o">(</span><span class="n">sql</span> <span class="n">at</span> <span class="nc">SqlWrapper</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="no">XX</span><span class="o">)</span> <span class="n">failed</span> <span class="n">in</span> <span class="no">X</span><span class="o">.</span><span class="na">XXX</span> <span class="n">s</span> <span class="n">due</span> <span class="n">to</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">shuffle</span><span class="o">.</span><span class="na">FetchFailedException</span><span class="o">:</span>
<span class="n">failed</span> <span class="n">to</span> <span class="n">allocate</span> <span class="no">XXXXX</span> <span class="nf">byte</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="n">of</span> <span class="n">direct</span> <span class="nf">memory</span> <span class="o">(</span><span class="nl">used:</span> <span class="no">XXXXX</span><span class="o">,</span> <span class="nl">max:</span> <span class="no">XXXXX</span><span class="o">)</span>
<span class="nc">Copy</span> <span class="n">to</span> <span class="n">clipboard</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>executor ë©”ëª¨ë¦¬ë¥¼ ë” ëŠ˜ë ¤ì£¼ê±°ë‚˜,
<code class="language-plaintext highlighter-rouge">--conf spark.executor.memory= &lt;XX&gt;g</code>
shuffle partitionì˜ ìˆ˜ë¥¼ ë” ëŠ˜ë ¤ì¤„ ìˆ˜ ìˆë‹¤.
<code class="language-plaintext highlighter-rouge">--spark.sql.shuffle.partitions</code></p>

<h3 id="executor-container-killed-by-yarn-for-exceeding-memory-limits">Executor container killed by YARN for exceeding memory limits</h3>
<p>Executorë¥¼ í˜¸ìŠ¤ë‹í•˜ëŠ” containerê°€ overhead taskë‚˜ executor taskë¥¼ ìœ„í•´ì„œ ë” ë§ì€ ë©”ëª¨ë¦¬ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ê²½ìš° ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> --><td class="rouge-code"><pre><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">SparkException</span><span class="o">:</span> <span class="nc">Job</span> <span class="n">aborted</span> <span class="n">due</span> <span class="n">to</span> <span class="n">stage</span> <span class="nl">failure:</span> <span class="nc">Task</span> <span class="no">X</span> <span class="n">in</span> <span class="n">stage</span> <span class="no">X</span><span class="o">.</span><span class="na">X</span> <span class="n">failed</span> <span class="no">X</span> <span class="n">times</span><span class="o">,</span>
<span class="n">most</span> <span class="n">recent</span> <span class="nl">failure:</span> <span class="nc">Lost</span> <span class="n">task</span> <span class="no">X</span><span class="o">.</span><span class="na">X</span> <span class="n">in</span> <span class="n">stage</span> <span class="no">X</span><span class="o">.</span><span class="na">X</span> <span class="o">(</span><span class="no">TID</span> <span class="no">XX</span><span class="o">,</span> <span class="no">XX</span><span class="o">.</span><span class="na">XX</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">XXX</span><span class="o">,</span> <span class="n">executor</span> <span class="no">X</span><span class="o">):</span> <span class="nc">ExecutorLostFailure</span>
<span class="o">(</span><span class="n">executor</span> <span class="no">X</span> <span class="n">exited</span> <span class="n">caused</span> <span class="n">by</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">running</span> <span class="n">tasks</span><span class="o">)</span> <span class="nl">Reason:</span> <span class="nc">Container</span> <span class="n">killed</span> <span class="n">by</span> <span class="no">YARN</span> <span class="k">for</span> <span class="n">exceeding</span> <span class="n">memory</span> <span class="n">limits</span><span class="o">.</span> <span class="no">XX</span><span class="o">.</span><span class="na">X</span> <span class="no">GB</span>
<span class="n">of</span> <span class="no">XX</span><span class="o">.</span><span class="na">X</span> <span class="no">GB</span> <span class="n">physical</span> <span class="n">memory</span> <span class="n">used</span><span class="o">.</span> <span class="nc">Consider</span> <span class="n">boosting</span> <span class="n">spark</span><span class="o">.</span><span class="na">yarn</span><span class="o">.</span><span class="na">executor</span><span class="o">.</span><span class="na">memoryOverhead</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>executorì˜ memory overhead ë¹„ì¤‘ì„ ë” ë†’ê²Œ ì„¸íŒ…í•´ì¤„ ìˆ˜ ìˆë‹¤.
executorì˜ ë©”ëª¨ë¦¬ ì˜¤ë²„í—¤ë“œ ì‚¬ì´ì¦ˆëŠ” executorì˜ ì‚¬ì´ì¦ˆì— ë¹„ë¡€í•´ì„œ ì»¤ì§„ë‹¤.(ëŒ€ëµ 6-10%)
best practiceëŠ” executor sizeì— ë§ì¶°ì„œ memory overhead sizeë„ ì¡°ì •í•´ì£¼ëŠ” ê²ƒì´ë‹¤.
<code class="language-plaintext highlighter-rouge">--conf spark.executor.memoryOverhead=XXXX</code>
ìœ„ì˜ ë°©ë²•ì´ í†µí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ë” í° ì¸ìŠ¤í„´ìŠ¤ë¡œ ì˜®ê¸°ê±°ë‚˜, ì½”ì–´ì˜ ê°œìˆ˜ë¥¼ ì¤„ì—¬ë³¼ ìˆ˜ë„ ìˆë‹¤.
ì½”ì–´ì˜ ê°œìˆ˜ë¥¼ ì¤„ì´ë©´ ë©”ëª¨ë¦¬ê°€ ë‚­ë¹„ë˜ê² ì§€ë§Œ, jobì€ ì¼ë‹¨ ëŒë¦´ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.
<code class="language-plaintext highlighter-rouge">--executor-cores=XX</code></p>

<h3 id="filealreadyexistsexception">FileAlreadyExistsException</h3>
<p>ì´ì „ì— ì‹¤íŒ¨í•œ taskì—ì„œ íŒŒì¼ë“¤ì„ ë‚¨ê²¨ì„œ FileAlreadyExistsExceptionë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.
executorê°€ ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ì‹¤íŒ¨í•˜ê³  ë‹¤ë¥¸ executorê°€ ë‹¤ì‹œ í•´ë‹¹ taskë¥¼ ì´ì–´ë°›ì•˜ì„ ë•Œ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
ì–´ë–¤ Spark executorê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ, Maximum numberë§Œí¼ retryí•˜ê³  ë‚˜ì„œ ì´ Exceptionì„ ë‚¨ê¸¸ ìˆ˜ ìˆë‹¤.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> --><td class="rouge-code"><pre><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">SparkException</span><span class="o">:</span> <span class="nc">Task</span> <span class="n">failed</span> <span class="k">while</span> <span class="n">writing</span> <span class="n">rows</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">datasources</span><span class="o">.</span><span class="na">FileFormatWriter</span><span class="err">$</span><span class="o">.</span><span class="na">org</span><span class="n">$apache$spark$sql$execution$datasources$FileFormatWriter</span><span class="err">$</span><span class="n">$executeTask</span><span class="o">(</span><span class="nc">FileFormatWriter</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">272</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">datasources</span><span class="o">.</span><span class="na">FileFormatWriter</span><span class="err">$</span><span class="n">$anonfun$write</span><span class="err">$</span><span class="mi">1</span><span class="err">$</span><span class="n">$anonfun$apply$mcV$sp</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">FileFormatWriter</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">191</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">datasources</span><span class="o">.</span><span class="na">FileFormatWriter</span><span class="err">$</span><span class="n">$anonfun$write</span><span class="err">$</span><span class="mi">1</span><span class="err">$</span><span class="n">$anonfun$apply$mcV$sp</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">FileFormatWriter</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">190</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">scheduler</span><span class="o">.</span><span class="na">ResultTask</span><span class="o">.</span><span class="na">runTask</span><span class="o">(</span><span class="nc">ResultTask</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">87</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">scheduler</span><span class="o">.</span><span class="na">Task</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">108</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">executor</span><span class="o">.</span><span class="na">Executor</span><span class="n">$TaskRunner</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Executor</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">335</span><span class="o">)</span>
<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="o">.</span><span class="na">runWorker</span><span class="o">(</span><span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1142</span><span class="o">)</span>
<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="n">$Worker</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">617</span><span class="o">)</span>
<span class="o">...</span> <span class="mi">1</span> <span class="n">more</span>
<span class="nc">Caused</span> <span class="nl">by:</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">FileAlreadyExistsException</span><span class="o">:</span> <span class="nl">s3:</span><span class="c1">//xxxxxx/xxxxxxx/xxxxxx/analysis-results/datasets/model=361/dataset=encoded_unified/dataset_version=vvvvv.snappy.parquet already exists</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">s3a</span><span class="o">.</span><span class="na">S3AFileSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">S3AFileSystem</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">806</span><span class="o">)</span>
<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">FileSystem</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">FileSystem</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">914</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>FileAlreadyExistsExceptionì˜ root causeì¸, ê°€ì¥ ì•ì„œ ì‹¤íŒ¨í•œ original executorì˜ ì‹¤íŒ¨ ì›ì¸ì„ ë°íŒë‹¤.</li>
</ul>

<h2 id="max-result-size-exceeded">Max result size exceeded</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre> <span class="nc">Typical</span> <span class="n">error</span> <span class="n">stream5</span><span class="o">/</span><span class="n">query_05_22_77</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">out</span><span class="o">:</span><span class="nl">Error:</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">SparkException</span><span class="o">:</span> <span class="nc">Job</span> <span class="n">aborted</span> <span class="n">due</span> <span class="n">to</span> <span class="n">stage</span> <span class="nl">failure:</span> <span class="nc">Total</span> <span class="n">size</span> <span class="n">of</span> <span class="n">serialized</span> <span class="n">results</span> <span class="n">of</span> <span class="mi">381610</span> <span class="n">tasks</span> <span class="o">(</span><span class="mf">5.0</span> <span class="no">GB</span><span class="o">)</span> <span class="n">is</span> <span class="n">bigger</span> <span class="n">than</span> <span class="n">spark</span><span class="o">.</span><span class="na">driver</span><span class="o">.</span><span class="na">maxResultSize</span> <span class="o">(</span><span class="mf">5.0</span> <span class="no">GB</span><span class="o">)</span> <span class="o">(</span><span class="n">state</span><span class="o">=,</span><span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="o">))</span> <span class="err">Â§â€¯</span> <span class="nc">Likely</span> <span class="n">to</span> <span class="n">occur</span> <span class="n">with</span> <span class="n">complex</span> <span class="no">SQL</span> <span class="n">on</span> <span class="n">large</span> <span class="n">data</span> <span class="n">volumes</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ì•„ë§ˆ ê±°ëŒ€í•œ ë°ì´íƒ€ ë³¼ë¥¨ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ë³µì¡í•œ SQLì—ì„œ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆë‹¤.
Spark Driver Max Result Sizeê°’ë³´ë‹¤ returnëœ resultê°€ í´ ë•Œ ë°œìƒí•œë‹¤.
<code class="language-plaintext highlighter-rouge">--conf spark.driver.maxResultSize</code> ì¬ì„¤ì •ì„ í†µí•´ í•´ê²°í•œë‹¤.</p>

<h2 id="too-large-frame-error">Too Large Frame error</h2>
<p>shuffle data size blockì˜ sizeê°€ ìŠ¤íŒŒí¬ê°€ ì²˜ë¦¬ í•  ìˆ˜ ìˆëŠ” í•œê³„ì¸ 2GBë³´ë‹¤ í° ê²½ìš° ë°œìƒ.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre>org.apache.spark.shuffle.FetchFailedException: Too large frame: XXXXXXXXXX
at org.apache.spark.storage.ShuffleBlockFetcherIterator.throwFetchFailedException(ShuffleBlockFetcherIterator.scala:513)
at org.apache.spark.storage.ShuffleBlockFetcherIterator.next(ShuffleBlockFetcherIterator.scala:444)

Caused by: java.lang.IllegalArgumentException: Too large frame: XXXXXXXXXX
at org.spark_project.guava.base.Preconditions.checkArgument(Preconditions.java:119)
at org.apache.spark.network.util.TransportFrameDecoder.decodeNext(TransportFrameDecoder.java:133)
</pre></td></tr></tbody></table></code></pre></div></div>
<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">spark.sql.shuffle.partitions</code>ì˜ valueë¥¼ default 200ì—ì„œ í° ê°’ìœ¼ë¡œ ì¡°ì • -&gt; <code class="language-plaintext highlighter-rouge">spark.default.parallelism</code> ì„ <code class="language-plaintext highlighter-rouge">spark.sql.shuffle.partitions</code>ê³¼ ë™ì¼í•œ ê°’ìœ¼ë¡œ ë³€ê²½</p>
  </li>
  <li>
    <p>issueê°€ ë°œìƒí•˜ëŠ” dataframeì„ ë°í˜€ë‚´ë³´ì. dataframe ìƒì„± ë’¤ì— action(ì–´ë–¤ actionì´ë“ , count ë“±)ì„ ë¶™ì—¬ì„œ dataframeë³„ë¡œ actionì„ ì‹œì¼œë³´ê³ , ë¬¸ì œê°€ ìƒê¸°ëŠ” ë°ì´í„°í”„ë ˆì„ì„ ë°í˜€ë‚´ë³¼ ìˆ˜ ìˆë‹¤. í•´ë‹¹ ë°ì´í„°í”„ë ˆì„ì„ repartitioní•˜ê³  cacheí•´ë†“ëŠ”ë‹¤. ì´ ë•Œ íŒŒí‹°ì…˜ì´ ëœ ë°ì´í„°ì˜ skewnessê°€ ì‹¬í•˜ë‹¤ë©´ ì½”ë“œì˜ íŠœë‹ì´ í•„ìš”í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
</ol>

<h2 id="spark-job-fails-with-throttling-in-s3-when-using-mfoc-aws">Spark job fails with throttling in S3 when using MFOC (AWS)</h2>
<p>ë¬´ê²ê³  ë†’ì€ ë¡œë“œë¥¼ ì¼ìœ¼í‚¤ëŠ” jobì—ì„œ, Multipart Uploadë¥¼ í™œì„±í™”í•œ uploadê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤.</p>

<p>Spark Override configurationì— ì•„ë˜ì™€ ê°™ì€ ì„¤ì •ë“¤ì„ ì¡ì•„ì¤€ë‹¤.</p>
<ul>
  <li>í•´ë‹¹ ì‘ì—…ì´ ì‹¤íŒ¨í•  ë•Œ, í•˜ë‘¡ì´ ë‹¤ë¥¸ pendingëœ uploadê¹Œì§€ ë‹¤ abort ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ì´ëŠ” ì—°ê´€ëœ ë‹¤ë¥¸ ì‘ì—…ë“¤ê¹Œì§€ ì‹¤íŒ¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
<code class="language-plaintext highlighter-rouge">spark.hadoop.fs.s3a.committer.staging.abort.pending.uploads</code> ì„¤ì •ì„ falseë¡œ ì¡ì•„ì¤€ë‹¤. ì´í›„ì— Bucket Lifecycle Policyë¥¼ í†µí•´ ì‹¤íŒ¨ëœ Multipart Uploaded fileì„ expireì‹œí‚¬ ìˆ˜ ìˆë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">spark.hadoop.fs.s3a.committer.threads</code>ì˜ default ê°’ì€ 8ì¸ë°, threadì˜ ìˆ˜ë¥¼ ë” ì¤„ì—¬ì¤€ë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">spark.hadoop.fs.s3a.committer.threads.max</code> ê°’ì„ ìœ„ì˜ thread ìˆ˜ì™€ ë§ì¶°ì¤€ë‹¤.
(ì¼ë°˜ì ìœ¼ë¡œ ìœ„ì˜ thread ìˆ˜ë¥¼ ëŠ˜ë ¤ì„œ s3 loading ì‘ì—…ì„ ë” ë¹ ë¥´ê²Œ ë§Œë“¤ ìˆ˜ ìˆì§€ë§Œ, S3ì—ì„œ ë„ˆë¬´ ë†’ì€ ë¡œë“œë¡œ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ê°€ ìƒê¸´ë‹¤ë©´ ì´ë¥¼ ì¤„ì—¬ì„œ ì‘ê²Œ ì„¤ì •í•´ë³¼ ìˆ˜ ìˆë‹¤.)</li>
  <li><code class="language-plaintext highlighter-rouge">spark.hadoop.fs.s3a.connection.timeout</code>ê°’ì„ default 200000 msì—ì„œ ë” ë†’ì€ ê°’ìœ¼ë¡œ ì¡ì•„ì¤„ ìˆ˜ ìˆë‹¤.</li>
</ul>

<h2 id="network-timeout">Network Timeout</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="mi">16</span><span class="o">/</span><span class="mo">07</span><span class="o">/</span><span class="mi">09</span> <span class="mo">01</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mi">18</span> <span class="no">ERROR</span> <span class="n">spark</span><span class="o">.</span><span class="na">ContextCleaner</span><span class="o">:</span> <span class="nc">Error</span> <span class="n">cleaning</span> <span class="n">broadcast</span> <span class="mi">28267</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcTimeoutException</span><span class="o">:</span> <span class="nc">Futures</span> <span class="n">timed</span> <span class="n">out</span> <span class="n">after</span> <span class="o">[</span><span class="mi">800</span> <span class="n">seconds</span><span class="o">].</span> <span class="nc">This</span> <span class="n">timeout</span> <span class="n">is</span> <span class="n">controlled</span> <span class="n">by</span> <span class="n">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">askTimeout</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcTimeout</span><span class="o">.</span><span class="na">org</span><span class="n">$apache$spark$rpc$RpcTimeout</span><span class="err">$</span> <span class="n">$createRpcTimeoutException</span><span class="o">(</span><span class="nc">RpcTimeout</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">48</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcTimeout</span><span class="err">$</span><span class="n">$anonfun$addMessageIfTimeout</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">applyOrElse</span><span class="o">(</span><span class="nc">RpcTimeout</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">63</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcTimeout</span><span class="err">$</span><span class="n">$anonfun$addMessageIfTimeout</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">applyOrElse</span><span class="o">(</span><span class="nc">RpcTimeout</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">59</span><span class="o">)</span> <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="na">PartialFunction</span><span class="n">$OrElse</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="nc">PartialFunction</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">167</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">RpcTimeout</span><span class="o">.</span><span class="na">awaitResult</span><span class="o">(</span><span class="nc">RpcTimeout</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">83</span><span class="o">)</span> <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">BlockManagerMaster</span><span class="o">.</span><span class="na">removeBroadcast</span><span class="o">(</span><span class="nc">BlockManagerMaster</span><span class="o">.</span><span class="na">scala</span><span class="o">:</span><span class="mi">143</span><span class="o">)</span> <span class="nc">And</span> <span class="n">timeout</span> <span class="n">exceptions</span> <span class="n">related</span> <span class="n">to</span> <span class="n">the</span> <span class="nl">following:</span> <span class="n">spark</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">ack</span><span class="o">.</span><span class="na">wait</span><span class="o">.</span><span class="na">timeout</span> <span class="n">spark</span><span class="o">.</span><span class="na">akka</span><span class="o">.</span><span class="na">timeout</span> <span class="n">spark</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">blockManagerSlaveTimeoutMs</span> <span class="n">spark</span><span class="o">.</span><span class="na">shuffle</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">connectionTimeout</span> <span class="n">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">askTimeout</span> <span class="n">spark</span><span class="o">.</span><span class="na">rpc</span><span class="o">.</span><span class="na">lookupTimeout</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒí™©ì— ë”°ë¼ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ì˜ íŠœë‹ì´ ìµœìš°ì„ ì´ê³ , ì•ˆì „ì¥ì¹˜ë¡œ timeout settingì„ ëŠ˜ë ¤ì¤„ ìˆ˜ ìˆë‹¤.<br />
<code class="language-plaintext highlighter-rouge">spark.network.timeout</code> íŒŒë¼ë¯¸í„°ë¥¼ ëŠ˜ë ¤ì¤€ë‹¤. defaultëŠ” 120ì´ë‹¤. ì—ëŸ¬ê°€ ë°œìƒí•œ timeout ì‹œê°„ë§Œí¼ ëŠ˜ë ¤ì¤˜ ë³¸ë‹¤.</p>

<h2 id="reference">Reference</h2>
<p>https://docs.qubole.com/en/latest/troubleshooting-guide/spark-ts/troubleshoot-spark.html
https://medium.com/ibm-data-ai/beginners-troubleshooting-guide-for-spark-ibm-analytics-engine-199019cfc6b4
https://www.slideshare.net/jcmia1/a-beginners-guide-on-troubleshooting-spark-applications</p>

:ET